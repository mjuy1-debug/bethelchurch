<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>말씀과 설교 - 화도벧엘교회</title>

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Noto+Serif+KR:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="styles.css">
    <script src="js/data.js"></script>

    <!-- Critical Image Pre-loader (Anti-Flash) -->
    <script>
        (function () {
            try {
                var data = null;
                var saved = localStorage.getItem('siteData');
                if (saved) {
                    data = JSON.parse(saved);
                } else if (typeof defaultData !== 'undefined') {
                    data = defaultData;
                }

                if (data) {
                    var css = '';

                    // Comprehensive list of image keys to pre-load
                    var imgKeys = [
                        'hero-bg', 'pastor-img',
                        'header-bg-about', 'header-bg-worship', 'header-bg-nextgen',
                        'header-bg-phil', 'header-bg-notice', 'header-bg-org',
                        'header-bg-family', 'header-bg-newcomer',
                        'ng-1-img', 'ng-2-img', 'ng-3-img',
                        'org-1-img', 'org-2-img', 'org-3-img', 'org-4-img', 'org-5-img',
                        'phil-1-img', 'phil-2-img', 'phil-3-img'
                    ];

                    imgKeys.forEach(function (key) {
                        if (data[key]) {
                            // Use !important to override inline styles and default CSS immediately
                            if (key === 'pastor-img') {
                                // For IMG tag: modify content
                                css += '[data-img-key="' + key + '"] { content: url("' + data[key] + '") !important; }';
                            } else {
                                // For DIV/Section backgrounds
                                css += '[data-img-key="' + key + '"] { background-image: url("' + data[key] + '") !important; }';
                            }
                        }
                    });

                    if (css) {
                        var style = document.createElement('style');
                        style.innerHTML = css;
                        document.head.appendChild(style);
                    }
                }
            } catch (e) {
                console.error('Pre-loader error:', e);
            }
        })();
    </script>
    <style>
        .sermon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .sermon-card {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            cursor: pointer;
        }

        .sermon-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .sermon-thumb {
            position: relative;
            padding-top: 56.25%;
            background: #eee;
            overflow: hidden;
        }

        .sermon-thumb img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sermon-thumb .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1.2rem;
            opacity: 0;
            transition: var(--transition);
        }

        .sermon-card:hover .sermon-thumb .play-icon {
            opacity: 1;
        }

        .sermon-info {
            padding: 20px;
        }

        .sermon-info .date {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 8px;
            display: block;
        }

        .sermon-info .title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .sermon-info .scripture {
            font-size: 0.95rem;
            color: #666;
            margin-bottom: 12px;
        }

        .btn-summary {
            display: inline-block;
            padding: 6px 12px;
            font-size: 0.85rem;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-summary:hover {
            background: var(--primary-color);
            color: #fff;
        }

        /* Summary Modal Styles */
        .summary-modal-content {
            max-width: 600px;
            width: 90%;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .summary-text {
            line-height: 1.6;
            font-size: 1rem;
            color: #333;
            margin-bottom: 20px;
            white-space: pre-line;
            /* Handle newlines */
        }

        .btn-download {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--secondary-color);
            color: #fff;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        .btn-download:hover {
            opacity: 0.9;
        }

        .close-summary {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .close-summary:hover {
            color: #333;
        }

        /* Pagination Styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 40px;
            gap: 10px;
        }

        .page-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #ddd;
            background: #fff;
            color: #333;
            border-radius: 50%;
            cursor: pointer;
            font-family: 'Noto Sans KR', sans-serif;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .page-btn.active {
            background: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }

        .page-btn:disabled {
            background: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
            border-color: #eee;
        }
    </style>
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="theme-color" content="#2c3e50">
</head>


<body>

    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="logo">
                <span class="logo-icon"><i class="fas fa-church"></i></span>
                <span class="logo-text">화도벧엘교회</span>
            </a>
            <nav class="nav">
                <ul class="nav-list">
                    <li><a href="about.html">교회소개</a>
                        <ul class="dropdown">
                            <li><a href="about.html#pastor">담임목사 인사말</a></li>
                            <li><a href="about.html#vision">비전과 가치</a></li>
                            <li><a href="about.html#location">오시는 길</a></li>
                        </ul>
                    </li>
                    <li><a href="worship.html">예배안내</a>
                        <ul class="dropdown">
                            <li><a href="worship.html">예배시간</a></li>
                            <li><a href="sermon.html">말씀과 설교</a></li>
                            <li><a href="family.html">성도의 기본생활</a></li>
                            <li><a href="newcomer.html">기도 제목과 목표</a></li>
                        </ul>
                    </li>
                    <li><a href="nextgen.html">다음세대</a>
                        <ul class="dropdown">
                            <li><a href="nextgen.html#sunday-school">주일학교</a></li>
                            <li><a href="nextgen.html#student">학생부</a></li>
                            <li><a href="nextgen.html#young-adults">청년부</a></li>
                        </ul>
                    </li>
                    <li><a href="index.html#org">교회기관</a>
                        <ul class="dropdown">
                            <li><a href="org_detail.html?id=org-1">갈렙남전도회</a></li>
                            <li><a href="org_detail.html?id=org-2">여호수아남전도회</a></li>
                            <li><a href="org_detail.html?id=org-3">나오미여전도회</a></li>
                            <li><a href="org_detail.html?id=org-4">루디아여전도회</a></li>
                            <li><a href="org_detail.html?id=org-5">요안나여전도회</a></li>
                            <li><a href="org_detail.html?id=org-6">시온성가대</a></li>
                        </ul>
                    </li>
                    <li><a href="philippines.html">필리핀지교회들</a>
                        <ul class="dropdown">
                            <li><a href="mission_detail.html?id=phil-1">비난고난벧엘교회</a></li>
                            <li><a href="mission_detail.html?id=phil-2">팔라완벧엘교회</a></li>
                            <li><a href="mission_detail.html?id=phil-3">나보타스벧엘교회</a></li>
                        </ul>
                    </li>
                    <li><a href="community.html">공지사항</a></li>
                </ul>
            </nav>
            <div class="header-utils">
                <a href="#" class="btn-search"><i class="fas fa-search"></i></a>
                <a href="#" class="btn-menu-mobile"><i class="fas fa-bars"></i></a>
            </div>
        </div>
    </header>

    <!-- Sub Hero -->
    <section class="sub-hero" data-img-key="header-bg-worship" style="background-image: url('./images/123.png');">
        <div class="hero-overlay"></div>
        <div class="container">
            <h1 class="sub-title">말씀과 설교</h1>
            <p class="sub-desc">하나님의 말씀이 선포되는 시간</p>
        </div>
    </section>

    <!-- Sermon List Section -->
    <section class="section">
        <div class="container">
            <div class="section-header text-center">
                <h2 class="title">주일예배 설교</h2>
                <p class="desc">지난 설교 말씀을 다시 들으실 수 있습니다.</p>
            </div>

            <div id="sermonListContainer" class="sermon-grid">
                <!-- Sermon Cards inserted here -->
            </div>

            <!-- Pagination -->
            <div id="paginationContainer" class="pagination"></div>
        </div>
    </section>


    <!-- Video Modal -->
    <div id="videoModal" class="modal">
        <div class="modal-content video-modal-content">
            <span class="close-modal">&times;</span>
            <div class="video-container">
                <iframe id="modalVideoFrame" src="" frameborder="0"
                    allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div id="summaryModal" class="modal">
        <div class="summary-modal-content">
            <span class="close-summary">&times;</span>
            <h3 id="summaryTitle" style="margin-bottom: 15px; font-size: 1.3rem;">설교 요약</h3>
            <div id="summaryBody" class="summary-text"></div>
            <div id="summaryDownloadArea" style="text-align: center; margin-top: 20px;">
                <a href="#" id="summaryDownloadBtn" class="btn-download" download>
                    <i class="fas fa-download"></i> 설교 요약 파일 다운로드
                </a>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- script src="js/data.js" moved to head -->
    <script src="js/main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadSermonList();
        });


        /* --------------------------------------------------------------------
           설교 목록 로딩
        -------------------------------------------------------------------- */
        /* --------------------------------------------------------------------
           설교 목록 로딩 (페이지네이션 적용)
        -------------------------------------------------------------------- */
        const ITEMS_PER_PAGE = 6;
        let currentPage = 1;
        let allSermons = [];

        function loadSermonList(page = 1) {
            const container = document.getElementById('sermonListContainer');
            const paginationContainer = document.getElementById('paginationContainer');
            if (!container) return;

            // Load data only once or if empty
            if (allSermons.length === 0) {
                let savedData = {};
                try {
                    savedData = JSON.parse(localStorage.getItem('siteData')) || {};
                } catch (e) { }

                const baseData = (typeof defaultData !== 'undefined') ? defaultData : {};
                const data = { ...baseData, ...savedData };

                allSermons = Array.isArray(data.sermons) ? [...data.sermons] : [];
                allSermons.sort((a, b) => b.id - a.id);
            }

            // Calculate pagination
            const totalItems = allSermons.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

            // Validate page
            if (page < 1) page = 1;
            if (page > totalPages && totalPages > 0) page = totalPages;
            currentPage = page;

            // Slice data
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const displaySermons = allSermons.slice(start, end);

            // Render Cards
            let html = '';
            if (displaySermons.length === 0) {
                html = '<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">등록된 설교가 없습니다.</p>';
            } else {
                displaySermons.forEach((sermon, index) => {
                    const realIndex = start + index; // For unique IDs if needed, but using thumb-index is fine locally
                    const videoId = extractId(sermon.videoUrl);
                    const thumb = videoId
                        ? `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`
                        : 'https://via.placeholder.com/320x180?text=NO+THUMB';

                    const embedUrl = getEmbedUrl(sermon.videoUrl);
                    const thumbId = `thumb-${realIndex}-${Date.now()}`; // Ensure uniqueness

                    html += `
            <div class="sermon-card" onclick="playInlineSermon('${embedUrl}', '${thumbId}')">
                <div class="sermon-thumb" id="${thumbId}">
                    <img src="${thumb}" alt="${sermon.title}">
                    <div class="play-icon"><i class="fas fa-play"></i></div>
                </div>
    
                <div class="sermon-info">
                    <span class="date">${sermon.date}</span>
                    <h3 class="title">${sermon.title}</h3>
                    <p class="scripture">${sermon.scripture} | ${sermon.preacher}</p>
                    ${(sermon.summary || sermon.file) ? `<button class="btn-summary" onclick="event.stopPropagation(); openSummaryModal(${realIndex})">말씀요약</button>` : ''}
                </div>
            </div>`;
                });
            }
            container.innerHTML = html;

            // Render Pagination Control
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            const paginationContainer = document.getElementById('paginationContainer');
            if (!paginationContainer || totalPages <= 1) {
                if (paginationContainer) paginationContainer.innerHTML = '';
                return;
            }

            let html = '';

            // Prev Button
            html += `<button class="page-btn" onclick="loadSermonList(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>`;

            // Page Numbers
            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="loadSermonList(${i})">${i}</button>`;
            }

            // Next Button
            html += `<button class="page-btn" onclick="loadSermonList(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>`;

            paginationContainer.innerHTML = html;
        }

        // Modified openSummaryModal to use actual sermon object from allSermons
        /* NOTICE: The previous openSummaryModal relied on reloading data and sorting. 
           Since we now have global 'allSermons', can directly use it. 
           However, let's keep it robust by letting it index into allSermons correctly. */


        /* --------------------------------------------------------------------
            playInlineSermon — iframe 동적 생성 (153오류 제거)
        -------------------------------------------------------------------- */
        function playInlineSermon(videoUrl, containerId) {

            // 개발 서버가 아닐 때 자동 차단
            if (location.protocol === "file:") {
                alert("영상은 로컬 파일(file://)에서 재생할 수 없습니다.\n반드시 개발 서버로 실행해주세요.");
                return;
            }

            const wrap = document.getElementById(containerId);
            if (!wrap) return;

            let final = videoUrl;
            const sep = final.includes("?") ? "&" : "?";

            // autoplay + mute 추가
            final += `${sep}autoplay=1&mute=1`;

            wrap.innerHTML = `
        <iframe 
            src="${final}"
            style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;"
            allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen>
        </iframe>
    `;
        }


        /* --------------------------------------------------------------------
           YouTube ID 추출
        -------------------------------------------------------------------- */
        function extractId(url) {
            if (!url) return "";
            const r = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const m = url.match(r);
            return (m && m[2].length === 11) ? m[2] : "";
        }


        /* --------------------------------------------------------------------
           YouTube 임베드 URL 생성
        -------------------------------------------------------------------- */
        function getEmbedUrl(url) {
            const id = extractId(url);
            return id ? `https://www.youtube.com/embed/${id}` : "";
        }

        /* --------------------------------------------------------------------
           Summary Modal Logic
        -------------------------------------------------------------------- */
        const summaryModal = document.getElementById('summaryModal');
        const summaryTitle = document.getElementById('summaryTitle');
        const summaryBody = document.getElementById('summaryBody');
        const summaryDownloadBtn = document.getElementById('summaryDownloadBtn');
        const closeSummaryBtn = document.querySelector('.close-summary');

        function openSummaryModal(index) {
            let savedData = {};
            try { savedData = JSON.parse(localStorage.getItem('siteData')) || {}; } catch (e) { }
            const baseData = (typeof defaultData !== 'undefined') ? defaultData : {};
            const data = { ...baseData, ...savedData };
            const sermons = Array.isArray(data.sermons) ? [...data.sermons] : [];
            sermons.sort((a, b) => b.id - a.id);

            const sermon = sermons[index];
            if (!sermon) return;

            // Set Title & content
            summaryTitle.innerText = `[말씀요약] ${sermon.title}`;
            summaryBody.innerText = sermon.summary ? sermon.summary : "요약 내용이 없습니다.";

            // Handle Download Button
            if (sermon.file) {
                summaryDownloadBtn.style.display = 'inline-flex';
                summaryDownloadBtn.href = sermon.file;
                // Check if it's PDF
                if (sermon.file.endsWith('.pdf') || sermon.file.includes('pdf')) {
                    summaryDownloadBtn.innerHTML = '<i class="fas fa-file-pdf"></i> 설교 요약 PDF 다운로드';
                } else {
                    summaryDownloadBtn.innerHTML = '<i class="fas fa-download"></i> 설교 요약 파일 다운로드';
                }
            } else {
                summaryDownloadBtn.style.display = 'none';
            }

            summaryModal.style.display = 'flex';
            setTimeout(() => { summaryModal.classList.add('show'); }, 10);
        }

        if (closeSummaryBtn) {
            closeSummaryBtn.addEventListener('click', () => {
                summaryModal.classList.remove('show');
                setTimeout(() => { summaryModal.style.display = 'none'; }, 300);
            });
        }

        // Close on outside click
        window.addEventListener('click', (e) => {
            if (e.target === summaryModal) {
                summaryModal.classList.remove('show');
                setTimeout(() => { summaryModal.style.display = 'none'; }, 300);
            }
        });

    </script>

</body>

</html>